(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{589:function(t,e,_){t.exports=_.p+"assets/img/spike.104b8287.png"},590:function(t,e,_){t.exports=_.p+"assets/img/xiadan.ab253703.png"},591:function(t,e,_){t.exports=_.p+"assets/img/tijiao.e7b53ad8.jpg"},656:function(t,e,_){"use strict";_.r(e);var a=_(10),v=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"一-秒杀系统整体架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-秒杀系统整体架构"}},[t._v("#")]),t._v(" 一.秒杀系统整体架构")]),t._v(" "),a("blockquote",[a("p",[t._v("秒杀整体设计图示如下，来源于李智慧老师的书籍<大型网站技术架构：核心原理与案例分析>")])]),t._v(" "),a("p",[a("img",{attrs:{src:_(589),alt:"秒杀"}})]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"二-秒杀前端设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-秒杀前端设计"}},[t._v("#")]),t._v(" 二.秒杀前端设计")]),t._v(" "),a("ol",[a("li",[t._v("秒杀系统独立部署，避免秒杀系统崩溃对其他系统造成影响。")]),t._v(" "),a("li",[t._v("秒杀页面静态化，部署在 CDN、Apache服务器上，不需要经过数据库和业务逻辑处理。")]),t._v(" "),a("li",[t._v("秒杀按钮点亮时机：\n"),a("ul",[a("li",[t._v("秒杀静态页有动态版本号的javascript脚本，每次刷新重新加载脚本。")]),t._v(" "),a("li",[t._v("javascript中有秒杀按钮点亮标志flag即和秒杀URL随机数参数。")]),t._v(" "),a("li",[t._v("秒杀时间点前根据随机数参数动态生成秒杀url，只有url没有随机数无法请求秒杀。")])])])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"三-秒杀数据库设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-秒杀数据库设计"}},[t._v("#")]),t._v(" 三.秒杀数据库设计")]),t._v(" "),a("blockquote",[a("p",[t._v("秒杀至少要两张表，一张是库存明细表，一张是秒杀订单表")])]),t._v(" "),a("ol",[a("li",[t._v("库存明细表(number字段是无符号Integer)")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("sku_id")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("name")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("number")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("valid_time")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("update_time")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("create_time")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("商品sku")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("商品名称")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("剩余数量")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("过期时间")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新时间")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("创建时间")])])])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("秒杀订单表(sku_id与user_phone 联合唯一索引)")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("sku_id")]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[t._v("user_phone")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("state")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("update_time")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("create_time")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("商品sku")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("电话号码")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("订单状态")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("更新时间")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("创建时间")])])])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"四-秒杀消峰"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-秒杀消峰"}},[t._v("#")]),t._v(" 四.秒杀消峰")]),t._v(" "),a("ol",[a("li",[t._v("秒杀答题。这个功能就是把峰值的下单请求拉长，从以前的 1s 之内延长到 2s~10s。比如只需要根据时间分片，只接受秒杀开始前2秒的请求，后面的进来也没有库存了。")]),t._v(" "),a("li",[t._v("排队机制。用消息队列来缓冲瞬时流量，把同步的直接调用转换成异步的间接推送，中间通过一个队列在一端承接瞬时的流量洪峰，在另一端平滑地将消息推送出去。")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"五-秒杀限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五-秒杀限流"}},[t._v("#")]),t._v(" 五.秒杀限流")]),t._v(" "),a("blockquote",[a("p",[t._v("秒杀消峰以后，进来的请求可能还是太多，商品根本就不够用，同时为了不让服务压力太大后崩溃需要限流。")])]),t._v(" "),a("ol",[a("li",[t._v("接入层限流\n"),a("ul",[a("li",[t._v("Nginx 连接数限流模块limit_conn 限瞬时并发数量，每秒请求达到一定频率，扔到503自定义秒杀拥挤页面")]),t._v(" "),a("li",[t._v("Nginx 请求限流模块limit_req 限每秒请求数，每秒请求达到一定频率，扔到502自定义秒杀拥挤页面")])])]),t._v(" "),a("li",[t._v("应用层限流\n"),a("ul",[a("li",[t._v("tomcat 配置最大连接数，队列处理请求数 等参数 ，acceptCount默认100 maxThreads 默认200")])])]),t._v(" "),a("li",[t._v("API层面\n"),a("ul",[a("li",[t._v("guava的RateLimiter 令牌桶算法，相应的算法还要 固定窗口、滑动窗口、漏桶算法。")])])])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"六-秒杀如何扣减库存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六-秒杀如何扣减库存"}},[t._v("#")]),t._v(" 六.秒杀如何扣减库存")]),t._v(" "),a("ol",[a("li",[t._v("秒杀下单减库存\n"),a("ul",[a("li",[t._v("每台服务器接受10个请求走下单逻辑, 剩下返回秒杀结束页面。")]),t._v(" "),a("li",[t._v("提交订单前，全局缓存提交订单数 < 缓存商品数量")])])])]),t._v(" "),a("p",[a("img",{attrs:{src:_(590),alt:"下单"}})]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("秒杀提交订单\n"),a("ul",[a("li",[t._v("提交订单，先插入明细 后修改库存，防止重复秒杀")])])])]),t._v(" "),a("p",[a("img",{attrs:{src:_(591),alt:"提交"}})]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"七-秒杀避免超卖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七-秒杀避免超卖"}},[t._v("#")]),t._v(" 七.秒杀避免超卖")]),t._v(" "),a("ol",[a("li",[t._v("库存表采用 无符号字段+乐观锁 更新。\nUPDATE [库存表] SET 库存数 = 库存数 - 1 WHERE 库存数 > 0")]),t._v(" "),a("li",[t._v("对user_phone和skuid加唯一索引。一个用户只能下一单。")]),t._v(" "),a("li",[t._v("商品库存为0，立即修改javascript脚本，点击秒杀进入结束页面。")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"八-秒杀超卖与反作弊"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#八-秒杀超卖与反作弊"}},[t._v("#")]),t._v(" 八.秒杀超卖与反作弊")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("10分钟时间内下单的数量仍然有可能超过库存数量")]),t._v(" "),a("ul",[a("li",[t._v("可以补货就进行补货。")]),t._v(" "),a("li",[t._v("不允许补货，付款告知失败。")])])]),t._v(" "),a("li",[a("p",[t._v("安全和反作弊的措施")]),t._v(" "),a("ul",[a("li",[t._v("被打标作弊的买家下单时不减库存，直接失败。")]),t._v(" "),a("li",[t._v("增加重复下单不付款次数限制，一天超过三次下单不减库存，直接失败。")])])])])])}),[],!1,null,null,null);e.default=v.exports}}]);