(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{486:function(t,e,a){"use strict";a.r(e);var l=a(0),_=Object(l.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("blockquote",[a("p",[t._v("面试：分库分表的时候你们是如何做数据迁移的？")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"一-考虑关键点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-考虑关键点"}},[t._v("#")]),t._v(" 一.考虑关键点")]),t._v(" "),a("ol",[a("li",[t._v("增量数据迁移方案。")]),t._v(" "),a("li",[t._v("存量数据即之前的旧数据迁移方案。")]),t._v(" "),a("li",[t._v("数据迁移完成后的验证。")])]),t._v(" "),a("br"),t._v(" "),a("h2",{attrs:{id:"二-数据迁移方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-数据迁移方案"}},[t._v("#")]),t._v(" 二.数据迁移方案")]),t._v(" "),a("h3",{attrs:{id:"停机迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#停机迁移"}},[t._v("#")]),t._v(" 停机迁移")]),t._v(" "),a("blockquote",[a("p",[t._v("停机迁移比较简单，他比较适用于内部用户使用的系统，不太适合c端用户交互较多的系统。")])]),t._v(" "),a("ol",[a("li",[t._v("告知停机时间或挂出停服公告。")]),t._v(" "),a("li",[t._v("进行数据表迁移\n"),a("ol",[a("li",[t._v("使用mysqldump命令进行迁移。")]),t._v(" "),a("li",[t._v("使用第三方的数据库迁移工具，如mysqlhotcopy。")])])]),t._v(" "),a("li",[t._v("数据对比验证。验证数据总量是否一致。验证一些关键数据查询是否一致。")])]),t._v(" "),a("br"),t._v(" "),a("h3",{attrs:{id:"不停机迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不停机迁移"}},[t._v("#")]),t._v(" 不停机迁移")]),t._v(" "),a("blockquote",[a("p",[t._v("不停机迁移的方案比较多，我们先列举常用的，然后在着重介绍对比。数据迁移分为三个部分存量数据迁移(已经存在老库的数据)、增量数据迁移(老数据迁移过程数据新增或数据更新)、迁移验证(验证迁移数据完整性)。")])]),t._v(" "),a("ol",[a("li",[t._v("双写：在连接层拦截SQL进行双写, 以某个时间点进行划分, 新产生的数据同时写入新表, 运行一段时间后将旧数据迁移至新表.")]),t._v(" "),a("li",[t._v("触发器: 通过触发器将新产生的数据同步到新表。")]),t._v(" "),a("li",[t._v("数据库日志: 从某一时间点T备份数据库, 将备份库的数据迁移至新表, 从时间点T读取日志, 恢复到新表, 并持续写入. 待两份数据保持同步后, 上线新代码.")])]),t._v(" "),a("br"),t._v(" "),a("h4",{attrs:{id:"存量迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存量迁移"}},[t._v("#")]),t._v(" 存量迁移")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}}),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("方案")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("优点")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("缺点")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("新增")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("备注")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("自己编写代码同步")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("定制化程度高")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("耗时多，需要开发、测试、部署、监控")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("存在不插入，不存在插入，del表中有记录不插入")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("ETL工具kettle同步")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("简单快速无需开发")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("定制化程度低")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("存在不插入，不存在插入")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("p",[a("a",{attrs:{href:"http://pansila.github.io/posts/ba926855/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://pansila.github.io/posts/ba926855/"),a("OutboundLink")],1)]),a("p",[t._v("同步完后需要查询del表是否有删除的记录，在用户装备表中进行删除核对")])])])])]),t._v(" "),a("br"),t._v(" "),a("h4",{attrs:{id:"增量迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#增量迁移"}},[t._v("#")]),t._v(" 增量迁移")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}}),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("方案")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("新增")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("更新")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("删除")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("优点")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("缺点")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("触发器")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("不存在则插入，存在则不动")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("存在则更新，不存在插入")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("存在则删除的同时添加del日志表，不存在只添加del日志表")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("开箱即用")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("需要开启Mysql的federated引擎-开启需要重启Mysql")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("使用Canal(本质是使用binlog)")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("准备Canal代码，解析binary log字节流对象，并把解析好的用户数据写入新库。")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("存在则更新，不存在插入")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("存在则删除的同时添加del日志表，不存在只添加del日志表")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("定制程度高")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[a("p",[t._v("需要开启binlog同步-开启需要重启Mysql")]),a("p",[t._v("需要开发代码"),a("br"),t._v("需要安装Canal")])])])])]),t._v(" "),a("br"),t._v(" "),a("h4",{attrs:{id:"迁移验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#迁移验证"}},[t._v("#")]),t._v(" 迁移验证")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"center"}}),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("验证")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("方式")])]),t._v(" "),a("th",{staticStyle:{"text-align":"center"}},[a("strong",[t._v("备注")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("总数验证")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询数据总量是否一致")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}})]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("关键数据筛查")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}},[t._v("查询某些数据量是否一致")]),t._v(" "),a("td",{staticStyle:{"text-align":"center"}})])])])])}),[],!1,null,null,null);e.default=_.exports}}]);